<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>Login NFC Absensi</title>
<style>
body {
  font-family: Arial;
  text-align: center;
  margin-top: 80px;
}
#status {
  font-size: 18px;
  margin-top: 20px;
}
</style>
</head>
<body>

<h2>LOGIN ABSENSI NFC</h2>
<button id="scan">SCAN KARTU NFC</button>
<div id="status">Tempelkan kartu NFC</div>

<script>
const statusEl = document.getElementById("status");

function beep(){
  const ctx = new AudioContext();
  const o = ctx.createOscillator();
  o.frequency.value = 900;
  o.connect(ctx.destination);
  o.start();
  o.stop(ctx.currentTime + 0.2);
}

document.getElementById("scan").onclick = async () => {
  if (!("NDEFReader" in window)) {
    statusEl.textContent = "Browser tidak mendukung NFC (Chrome Android)";
    return;
  }

  try {
    const ndef = new NDEFReader();
    await ndef.scan();
    statusEl.textContent = "Membaca kartu NFC...";

    ndef.onreading = e => {
      let text = "";
      for (const r of e.message.records) {
        if (r.recordType === "text") {
          text += new TextDecoder(r.encoding).decode(r.data) + "\n";
        }
      }

      let nama="", role="", kelas="";
      text.split("\n").forEach(l=>{
        if(l.startsWith("NAMA="))  nama  = l.replace("NAMA=","").trim();
        if(l.startsWith("ROLE="))  role  = l.replace("ROLE=","").trim();
        if(l.startsWith("KELAS=")) kelas = l.replace("KELAS=","").trim();
      });

      if(!nama || !role){
        statusEl.textContent = "Data kartu tidak valid";
        return;
      }

      // simpan sesi login
      localStorage.setItem("user", JSON.stringify({
        nama, role, kelas
      }));

      beep();
      statusEl.textContent = `Selamat datang ${nama} (${role})`;

      // arahkan sesuai role
      if(role === "GERBANG")   location.href = "gerbang.html";
      else if(role === "OPERATOR") location.href = "operator.html";
      else if(role === "WALI") location.href = "wali.html";
      else if(role === "GURU") location.href = "guru.html";
      else if(role === "SISWA") location.href = "siswa.html";
      else statusEl.textContent = "Role tidak dikenali";
    };

  } catch (err) {
    statusEl.textContent = "Gagal membaca NFC";
  }
};
</script>

</body>
</html>
