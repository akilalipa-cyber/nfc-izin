<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>Sistem Laporan NFC</title>

<style>
body { font-family: Arial; }
#timer { font-size: 24px; color: red; }
#log {
  max-height: 320px;
  overflow-y: auto;
  border: 1px solid #000;
  padding: 10px;
}
.merah { color: red; }
.hijau { color: green; }
</style>
</head>
<body>

<h2>Sistem Laporan NFC</h2>

<button id="scanKeluar">SCAN LAPORAN KELUAR</button>
<button id="scanMasuk">SCAN LAPORAN MASUK</button>

<pre id="info">Menunggu NFC...</pre>
<h3 id="timer">-</h3>

<h3>Daftar Laporan</h3>
<ul id="log"></ul>

<script>
const BATAS = 5; // detik
let interval = null;
let mode = ""; // keluar / masuk

const laporanKeluar = {}; // {nama: waktu}
const info = document.getElementById("info");
const timer = document.getElementById("timer");
const log = document.getElementById("log");

// ===== CEK NFC =====
if (!("NDEFReader" in window)) {
  info.textContent = "Web NFC tidak didukung. Gunakan Chrome Android.";
}

// ===== TOMBOL =====
document.getElementById("scanKeluar").onclick = () => mulaiScan("keluar");
document.getElementById("scanMasuk").onclick = () => mulaiScan("masuk");

// ===== SCAN =====
async function mulaiScan(jenis) {
  mode = jenis;
  try {
    const ndef = new NDEFReader();
    await ndef.scan();
    info.textContent = `Scan untuk laporan ${jenis.toUpperCase()}...`;

    ndef.onreading = (e) => {
      let text = "";
      for (const r of e.message.records) {
        if (r.recordType === "text") {
          text += new TextDecoder(r.encoding).decode(r.data);
        }
      }

      let nama="", kelas="";
      text.split("\n").forEach(l=>{
        if(l.startsWith("NAMA=")) nama=l.replace("NAMA=","").trim();
        if(l.startsWith("KELAS=")) kelas=l.replace("KELAS=","").trim();
      });

      if(!nama || !kelas){
        info.textContent="Format NFC salah";
        return;
      }

      if(mode==="keluar") laporanKeluarFunc(nama, kelas);
      if(mode==="masuk") laporanMasukFunc(nama, kelas);
    };

  } catch {
    info.textContent="Gagal scan NFC";
  }
}

// ===== LAPORAN KELUAR =====
function laporanKeluarFunc(nama, kelas){
  laporanKeluar[nama] = Date.now();
  beep();
  info.textContent = `${nama} (${kelas}) LAPOR KELUAR`;
  mulaiTimer();
  tambahLog(`${nama} (${kelas}) → LAPOR KELUAR`, "hijau");
}

// ===== LAPORAN MASUK =====
function laporanMasukFunc(nama, kelas){
  if(!laporanKeluar[nama]){
    tambahLog(`${nama} (${kelas}) → TIDAK ADA DATA KELUAR`, "merah");
    return;
  }

  const selisih = Math.floor((Date.now() - laporanKeluar[nama]) / 1000);
  let status = "";
  let warna = "";

  if(selisih <= BATAS){
    status = `TEPAT WAKTU | ${selisih} detik`;
    warna = "hijau";
  } else {
    status = `BOLOS | ${selisih} detik`;
    warna = "merah";
  }

  beep();
  tambahLog(`${nama} (${kelas}) → LAPOR MASUK → ${status}`, warna);
  delete laporanKeluar[nama];
}

// ===== TIMER VISUAL =====
function mulaiTimer(){
  let sisa = BATAS;
  clearInterval(interval);
  timer.textContent = `Sisa waktu: ${sisa}`;
  interval = setInterval(()=>{
    sisa--;
    timer.textContent = `Sisa waktu: ${sisa}`;
    if(sisa<=0){
      clearInterval(interval);
      timer.textContent="WAKTU HABIS";
    }
  },1000);
}

// ===== BEEP 2X =====
function beep(){
  const ctx=new AudioContext();
  let t=ctx.currentTime;
  for(let i=0;i<2;i++){
    const o=ctx.createOscillator();
    o.frequency.value=900;
    o.connect(ctx.destination);
    o.start(t+i*0.35);
    o.stop(t+i*0.35+0.2);
  }
}

// ===== LOG =====
function tambahLog(text,warna){
  const li=document.createElement("li");
  li.className=warna;
  li.textContent=`${new Date().toLocaleTimeString()} - ${text}`;
  log.prepend(li);
}
</script>

</body>
</html>
