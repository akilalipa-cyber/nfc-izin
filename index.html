<script>
let nama = "";
let kelas = "";
let interval = null;

// simpan laporan terakhir tiap nama
const laporanTerakhir = {};

const dataEl = document.getElementById("data");
const timerEl = document.getElementById("timer");
const logEl = document.getElementById("log");

// ===== SCAN NFC =====
document.getElementById("scan").onclick = async () => {
  try {
    const ndef = new NDEFReader();
    await ndef.scan();
    dataEl.textContent = "Tempelkan kartu NFC...";

    ndef.onreading = (event) => {
      let text = "";

      for (const record of event.message.records) {
        if (record.recordType === "text") {
          const decoder = new TextDecoder(record.encoding);
          text += decoder.decode(record.data) + "\n";
        }
      }

      if (!text) {
        dataEl.textContent = "Data NFC tidak valid";
        return;
      }

      nama = "";
      kelas = "";

      text.split("\n").forEach(line => {
        if (line.startsWith("NAMA=")) nama = line.replace("NAMA=", "").trim();
        if (line.startsWith("KELAS=")) kelas = line.replace("KELAS=", "").trim();
      });

      if (!nama || !kelas) {
        dataEl.textContent = "Format NFC salah";
        return;
      }

      dataEl.textContent = `Terdeteksi: ${nama} (${kelas})`;

      if (interval) clearInterval(interval);
      mulaiCountdownDetik(5); // ⬅️ DIGANTI 5 DETIK
    };
  } catch (e) {
    dataEl.textContent = "NFC gagal dibaca";
  }
};

// ===== COUNTDOWN =====
function mulaiCountdownDetik(detik) {
  let waktu = detik;
  timerEl.textContent = `Sisa waktu: ${waktu} detik`;

  interval = setInterval(() => {
    waktu--;
    timerEl.textContent = `Sisa waktu: ${waktu} detik`;

    if (waktu <= 0) {
      clearInterval(interval);
      timerEl.textContent = "WAKTU HABIS";
      bunyiBeepDuaKali();
      tambahLogDenganCek();
      sebutkanNama();
    }
  }, 1000);
}

// ===== BEEP 2 KALI =====
function bunyiBeepDuaKali() {
  const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  let start = audioCtx.currentTime;

  for (let i = 0; i < 2; i++) {
    const osc = audioCtx.createOscillator();
    const gain = audioCtx.createGain();

    osc.type = "sine";
    osc.frequency.value = 1000;

    osc.connect(gain);
    gain.connect(audioCtx.destination);

    osc.start(start + i * 0.4);
    osc.stop(start + i * 0.4 + 0.2);
  }
}

// ===== LOG DENGAN CEK MELAPOR ULANG =====
function tambahLogDenganCek() {
  const sekarang = Date.now();
  let keterangan = "laporan pertama";

  if (laporanTerakhir[nama]) {
    const selisih = Math.floor((sekarang - laporanTerakhir[nama]) / 1000);
    keterangan = `melapor ulang, tepat waktu. Waktu: ${selisih} detik`;
  }

  laporanTerakhir[nama] = sekarang;

  const li = document.createElement("li");
  const jam = new Date().toLocaleTimeString();

  li.textContent = `${jam} - ${nama} (${kelas}) → ${keterangan}`;
  logEl.prepend(li);
}

// ===== SEBUTKAN NAMA =====
function sebutkanNama() {
  const msg = new SpeechSynthesisUtterance(
    `${nama} kelas ${kelas}, silakan`
  );
  msg.lang = "id-ID";
  speechSynthesis.speak(msg);
}
</script>
