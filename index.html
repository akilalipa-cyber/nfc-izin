<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>Gerbang NFC Sekolah</title>

<style>
body { font-family: Arial; }
#timer { font-size: 24px; color: red; }
#log {
  max-height: 350px;
  overflow-y: auto;
  border: 1px solid #000;
  padding: 10px;
}
.hijau { color: green; }
.merah { color: red; }
</style>
</head>
<body>

<h2>Sistem Gerbang NFC</h2>

<button id="keluar">SCAN KELUAR</button>
<button id="masuk">SCAN MASUK</button>

<pre id="info">Menunggu NFC...</pre>
<h3 id="timer">-</h3>

<h3>Daftar Laporan</h3>
<ul id="log"></ul>

<script>
const BATAS = 5; // detik
let mode = "";
let interval = null;

const siswa = {}; // database sementara

const info = document.getElementById("info");
const timer = document.getElementById("timer");
const log = document.getElementById("log");

// ===== CEK NFC =====
if (!("NDEFReader" in window)) {
  info.textContent = "Gunakan Chrome Android (Web NFC)";
}

// ===== TOMBOL =====
document.getElementById("keluar").onclick = () => scan("keluar");
document.getElementById("masuk").onclick = () => scan("masuk");

// ===== SCAN NFC =====
async function scan(jenis) {
  mode = jenis;
  try {
    const ndef = new NDEFReader();
    await ndef.scan();
    info.textContent = `Scan NFC (${jenis.toUpperCase()})`;

    ndef.onreading = e => {
      let text = "";
      for (const r of e.message.records) {
        if (r.recordType === "text") {
          text += new TextDecoder(r.encoding).decode(r.data);
        }
      }

      let nama="", kelas="";
      text.split("\n").forEach(l=>{
        if(l.startsWith("NAMA=")) nama=l.replace("NAMA=","").trim();
        if(l.startsWith("KELAS=")) kelas=l.replace("KELAS=","").trim();
      });

      if(!nama || !kelas){
        info.textContent="Format NFC salah";
        return;
      }

      if(mode==="keluar") laporKeluar(nama, kelas);
      else laporMasuk(nama, kelas);
    };
  } catch {
    info.textContent="Gagal membaca NFC";
  }
}

// ===== LAPOR KELUAR =====
function laporKeluar(nama, kelas){
  siswa[nama] = {
    kelas,
    keluar: Date.now(),
    status: "menunggu"
  };

  mulaiTimer();
  beep();
  info.textContent = `${nama} (${kelas}) KELUAR`;
  logData(`${nama} (${kelas}) → LAPOR KELUAR`, "hijau");
}

// ===== LAPOR MASUK =====
function laporMasuk(nama, kelas){
  if(!siswa[nama]){
    logData(`${nama} (${kelas}) → TIDAK ADA DATA KELUAR`, "merah");
    return;
  }

  const now = Date.now();
  const selisih = Math.floor((now - siswa[nama].keluar)/1000);
  let teks="", warna="";

  if(selisih <= BATAS){
    teks = `TEPAT WAKTU (+${selisih} detik)`;
    warna = "hijau";
    siswa[nama].status = "tepat";
  } else {
    const minus = selisih - BATAS;
    teks = `BOLOS (-${minus} detik, total ${selisih} detik)`;
    warna = "merah";
    siswa[nama].status = "bolos";
  }

  beep();
  logData(`${nama} (${kelas}) → LAPOR MASUK → ${teks}`, warna);
  delete siswa[nama];
}

// ===== TIMER VISUAL =====
function mulaiTimer(){
  clearInterval(interval);
  let sisa = BATAS;
  timer.textContent = `Sisa waktu: ${sisa}`;

  interval = setInterval(()=>{
    sisa--;
    timer.textContent = `Sisa waktu: ${sisa}`;
    if(sisa <= 0){
      timer.textContent = "WAKTU HABIS";
      clearInterval(interval);
    }
  },1000);
}

// ===== BEEP 2X =====
function beep(){
  const ctx = new AudioContext();
  let t = ctx.currentTime;
  for(let i=0;i<2;i++){
    const o = ctx.createOscillator();
    o.frequency.value = 900;
    o.connect(ctx.destination);
    o.start(t + i*0.35);
    o.stop(t + i*0.35 + 0.2);
  }
}

// ===== LOG =====
function logData(text, warna){
  const li = document.createElement("li");
  li.className = warna;
  li.textContent = `${new Date().toLocaleTimeString()} - ${text}`;
  log.prepend(li);
}
</script>

</body>
</html>
