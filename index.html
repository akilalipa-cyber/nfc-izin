<script>
const dataEl = document.getElementById("data");
const timerEl = document.getElementById("timer");
const logEl = document.getElementById("log");
const scanBtn = document.getElementById("scan");

let laporanTerakhir = {};
const BATAS = 5;
let interval;

scanBtn.onclick = () => {
  dataEl.textContent = "NFC terdeteksi (SIMULASI)";
  proses("Tuan", "XI IPA");
};

function proses(nama, kelas) {
  let sisa = BATAS;
  timerEl.textContent = `Sisa waktu: ${sisa} detik`;

  clearInterval(interval);
  interval = setInterval(() => {
    sisa--;
    timerEl.textContent = `Sisa waktu: ${sisa} detik`;

    if (sisa === 0) {
      clearInterval(interval);
      timerEl.textContent = "WAKTU HABIS";
      laporan(nama, kelas);
      beep();
    }
  }, 1000);
}

function laporan(nama, kelas) {
  const sekarang = Date.now();
  let status = "LAPORAN PERTAMA";
  let warna = "black";
  let catatan = "-";

  if (laporanTerakhir[nama]) {
    let selisih = Math.floor((sekarang - laporanTerakhir[nama]) / 1000);
    catatan = selisih + " detik";
    if (selisih <= BATAS) {
      status = "TEPAT WAKTU";
    } else {
      status = "BOLOS";
      warna = "red";
    }
  }

  laporanTerakhir[nama] = sekarang;

  const li = document.createElement("li");
  li.style.color = warna;
  li.textContent = `${nama} (${kelas}) â†’ ${status} | ${catatan}`;
  logEl.prepend(li);
}

function beep() {
  const ctx = new AudioContext();
  for (let i = 0; i < 2; i++) {
    const o = ctx.createOscillator();
    o.frequency.value = 1000;
    o.connect(ctx.destination);
    o.start(ctx.currentTime + i * 0.3);
    o.stop(ctx.currentTime + i * 0.3 + 0.2);
  }
}
</script>
