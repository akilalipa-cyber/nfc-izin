<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>NFC Laporan Sekolah</title>

<style>
  body {
    font-family: Arial, sans-serif;
  }

  #timer {
    font-size: 26px;
    color: red;
    margin-top: 10px;
  }

  #log {
    max-height: 300px;
    overflow-y: auto;
    border: 1px solid #333;
    padding: 10px;
  }

  ul {
    padding-left: 20px;
  }
</style>
</head>
<body>

<h2>Scan NFC</h2>
<button id="scan">SCAN KARTU</button>

<pre id="data">Menunggu NFC...</pre>
<h2 id="timer">-</h2>

<h3>Daftar Laporan</h3>
<ul id="log"></ul>

<script>
let nama = "";
let kelas = "";
let interval = null;

const dataEl = document.getElementById("data");
const timerEl = document.getElementById("timer");
const logEl = document.getElementById("log");

// ===== SCAN NFC =====
document.getElementById("scan").onclick = async () => {
  try {
    const ndef = new NDEFReader();
    await ndef.scan();
    dataEl.textContent = "Tempelkan kartu NFC...";

    ndef.onreading = (event) => {
      let text = "";

      for (const record of event.message.records) {
        if (record.recordType === "text") {
          const decoder = new TextDecoder(record.encoding);
          text += decoder.decode(record.data) + "\n";
        }
      }

      if (!text) {
        dataEl.textContent = "Data NFC tidak terbaca (bukan Text)";
        return;
      }

      dataEl.textContent = text;

      // reset data
      nama = "";
      kelas = "";

      text.split("\n").forEach(line => {
        if (line.startsWith("NAMA=")) nama = line.replace("NAMA=", "").trim();
        if (line.startsWith("KELAS=")) kelas = line.replace("KELAS=", "").trim();
      });

      if (!nama || !kelas) {
        dataEl.textContent = "Format NFC salah";
        return;
      }

      if (interval) clearInterval(interval);
      mulaiCountdownDetik(3);
    };
  } catch (e) {
    dataEl.textContent = "NFC gagal dibaca / tidak diizinkan";
  }
};

// ===== COUNTDOWN =====
function mulaiCountdownDetik(detik) {
  let waktu = detik;
  timerEl.textContent = `Sisa waktu: ${waktu} detik`;

  interval = setInterval(() => {
    waktu--;
    timerEl.textContent = `Sisa waktu: ${waktu} detik`;

    if (waktu <= 0) {
      clearInterval(interval);
      timerEl.textContent = "WAKTU HABIS";
      bunyiBeepDuaKali();
      tambahLog();
      sebutkanNama();
    }
  }, 1000);
}

// ===== BEEP 2 KALI =====
function bunyiBeepDuaKali() {
  const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  let start = audioCtx.currentTime;

  for (let i = 0; i < 2; i++) {
    const osc = audioCtx.createOscillator();
    const gain = audioCtx.createGain();

    osc.type = "sine";
    osc.frequency.value = 1000;

    osc.connect(gain);
    gain.connect(audioCtx.destination);

    osc.start(start + i * 0.4);
    osc.stop(start + i * 0.4 + 0.2);
  }
}

// ===== TAMBAH LAPORAN (TANPA BATAS) =====
function tambahLog() {
  const li = document.createElement("li");
  const jam = new Date().toLocaleTimeString();

  li.textContent = `${jam} - ${nama} (${kelas})`;
  logEl.prepend(li);
}

// ===== SEBUTKAN NAMA =====
function sebutkanNama() {
  const msg = new SpeechSynthesisUtterance(
    `${nama} kelas ${kelas} silakan`
  );
  msg.lang = "id-ID";
  speechSynthesis.speak(msg);
}
</script>

</body>
</html>
