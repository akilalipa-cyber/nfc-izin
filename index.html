<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>Gerbang NFC Sekolah</title>

<style>
body { font-family: Arial, sans-serif; }
#timer { font-size: 24px; color: red; margin-top: 10px; }
#log {
  max-height: 350px;
  overflow-y: auto;
  border: 1px solid #000;
  padding: 10px;
}
.hijau { color: green; }
.merah { color: red; }
</style>
</head>

<body>

<h2>Sistem Gerbang NFC</h2>

<button id="keluar">SCAN KELUAR</button>
<button id="masuk">SCAN MASUK</button>

<pre id="info">Menunggu NFC...</pre>
<h3 id="timer">-</h3>

<h3>Daftar Laporan</h3>
<ul id="log"></ul>

<script>
const BATAS = 5; // detik toleransi
let mode = "";
let intervalTimer = null;

// database sementara siswa
const siswa = {};

const info = document.getElementById("info");
const timerEl = document.getElementById("timer");
const logEl = document.getElementById("log");

// ===== CEK NFC =====
if (!("NDEFReader" in window)) {
  info.textContent = "Browser tidak mendukung Web NFC (gunakan Chrome Android)";
}

// ===== TOMBOL =====
document.getElementById("keluar").onclick = () => mulaiScan("keluar");
document.getElementById("masuk").onclick = () => mulaiScan("masuk");

// ===== SCAN NFC =====
async function mulaiScan(jenis) {
  mode = jenis;
  try {
    const ndef = new NDEFReader();
    await ndef.scan();
    info.textContent = `Scan NFC (${jenis.toUpperCase()})`;

    ndef.onreading = e => {
      let text = "";
      for (const r of e.message.records) {
        if (r.recordType === "text") {
          text += new TextDecoder(r.encoding).decode(r.data);
        }
      }

      let nama = "", kelas = "";
      text.split("\n").forEach(l => {
        if (l.startsWith("NAMA=")) nama = l.replace("NAMA=", "").trim();
        if (l.startsWith("KELAS=")) kelas = l.replace("KELAS=", "").trim();
      });

      if (!nama || !kelas) {
        info.textContent = "Format NFC salah";
        return;
      }

      if (mode === "keluar") laporKeluar(nama, kelas);
      if (mode === "masuk") laporMasuk(nama, kelas);
    };
  } catch {
    info.textContent = "Gagal membaca NFC";
  }
}

// ===== LAPOR KELUAR =====
function laporKeluar(nama, kelas) {
  if (siswa[nama]) return; // cegah dobel

  siswa[nama] = {
    kelas,
    waktuKeluar: Date.now()
  };

  mulaiTimer(siswa[nama].waktuKeluar);
  bunyiBeep();

  info.textContent = `${nama} (${kelas}) LAPOR KELUAR`;
  tambahLog(`${nama} (${kelas}) → LAPOR KELUAR`, "hijau");
}

// ===== LAPOR MASUK =====
function laporMasuk(nama, kelas) {
  if (!siswa[nama]) {
    tambahLog(`${nama} (${kelas}) → TIDAK ADA DATA KELUAR`, "merah");
    return;
  }

  const now = Date.now();
  const selisih = Math.floor((now - siswa[nama].waktuKeluar) / 1000);

  let teks = "";
  let warna = "";

  if (selisih <= BATAS) {
    teks = `TEPAT WAKTU (+${selisih} detik)`;
    warna = "hijau";
  } else {
    const minus = selisih - BATAS;
    teks = `BOLOS (-${minus} detik)`;
    warna = "merah";
  }

  bunyiBeep();
  tambahLog(`${nama} (${kelas}) → LAPOR MASUK → ${teks}`, warna);

  delete siswa[nama];
  clearInterval(intervalTimer);
  timerEl.textContent = "-";
}

// ===== TIMER REAL-TIME =====
function mulaiTimer(waktuAwal) {
  clearInterval(intervalTimer);

  intervalTimer = setInterval(() => {
    const now = Date.now();
    const lewat = Math.floor((now - waktuAwal) / 1000);
    const sisa = BATAS - lewat;

    if (sisa > 0) {
      timerEl.textContent = `Sisa waktu: ${sisa} detik`;
    } else {
      timerEl.textContent = `TERLAMBAT: ${Math.abs(sisa)} detik`;
    }
  }, 1000);
}

// ===== BEEP 2x =====
function bunyiBeep() {
  const ctx = new AudioContext();
  let t = ctx.currentTime;

  for (let i = 0; i < 2; i++) {
    const osc = ctx.createOscillator();
    osc.frequency.value = 900;
    osc.connect(ctx.destination);
    osc.start(t + i * 0.35);
    osc.stop(t + i * 0.35 + 0.2);
  }
}

// ===== LOG =====
function tambahLog(teks, warna) {
  const li = document.createElement("li");
  li.className = warna;
  li.textContent = `${new Date().toLocaleTimeString()} - ${teks}`;
  logEl.prepend(li);
}
</script>

</body>
</html>
